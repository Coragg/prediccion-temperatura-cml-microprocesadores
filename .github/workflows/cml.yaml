name: CML Temperature Prediction

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

jobs:
  train-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install numpy pandas scipy scikit-learn matplotlib

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Train model
        run: python src/train.py

      - name: Generate plots
        run: python src/cluster_plot.py

      - name: Create CML report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Temperature Prediction Report" >> report.md
          echo "" >> report.md
          echo "## Model: Random Forest Regressor" >> report.md
          echo "" >> report.md
          echo "## Model Metrics" >> report.md
          echo "" >> report.md
          echo '```json' >> report.md
          cat metrics.json >> report.md
          echo "" >> report.md
          echo '```' >> report.md
          echo "" >> report.md
          echo "## Visualizations" >> report.md
          echo "" >> report.md
          cml publish cluster_plot.png --md >> report.md
          echo "" >> report.md
          cml comment create report.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ml-results
          path: |
            metrics.json
            predictions.csv
            feature_importance.csv
            cluster_plot.png
            report.md
